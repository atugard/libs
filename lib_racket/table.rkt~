#lang racket
(require "types.rkt")
(require "mutable.rkt")

(provide make-table table? get-val insert-table!)

(define (make-table . args)
  (cond [(null? args) (mlist '*table*)]
        [(null? (cdr args)) 
         (let ((keys (car args)))
           (define (rec ks)
             (if (null? ks)
                 null
                 (mcons (mcons (car ks) null) (rec (cdr ks)))))
           (mcons '*table* (rec keys)))]
        [(null? (cddr args))
         (let ((keys (car args))
               (vals (cadr args)))
           (cond [(= (length keys) (length vals))
                  (define (rec ks vs)
                    (if (null? ks)
                        null
                        (mcons (mcons (car ks) (car vs)) (rec (cdr ks) (cdr vs)))))
                  (mcons '*table* (rec keys vals))]
                 [else (error "Arguments must be lists of equal length. You gave: " keys vals)]))]
        [else
         (error "MAKE-TABLE takes at most two arguments. You gave: " (length args))]))
(define (record? record)
  (and (mpair? record) (not (mpair? (mcar record))) (not (mpair? (mcdr record)))))
(define (table? t)
  (if (mpair? t)
      (eq? (mcar t) '*table*)
      false))
(define (record->key record)
  (mcar record))
(define (record->val record)
  (mcdr record))
(define (get-val key t)
  (if (table? t)
      (let ((data (cdr t)))
        (define (rec d)
          (cond [(null? d) false]
                [(equal? key (record->key (car d))) (record->val (car d))]
                [else (rec (cdr d))]))
        (rec data))
      null))
(define (insert-table! key val table)
  (cond [(table? table)
         (define (rec t)
           (cond [(null? (mcdr t))
                  (set-mcdr! t (mlist (mcons key val)))]
                 [(equal? (record->key (mcar t)) key)
                  (set-mcdr! (mcar t) val)]
                 [else
                  (rec (mcdr t))]))
         (rec (mcdr table))]
        [error "Second argument must be a table. You gave: " table]))
